#!/usr/bin/env php
<?php

$root = dirname(__DIR__);

if (!is_file(sprintf('%s/vendor/autoload.php', $root))) {
    $root = dirname(__DIR__, 4);
}

require sprintf('%s/vendor/autoload.php', $root);

use Symfony\Component\HttpClient\HttpClient;

if (!($argc == 2 && $argv[1] !== '')) {
    fprintf(STDERR, "Usage: %s WORD" . PHP_EOL, $argv[0]);
    exit(1);
}

$client = HttpClient::create();
$response = $client->request(
    method: 'GET',
    url: 'http://fanyi.youdao.com/openapi.do',
    options: [
        'query' => [
            'keyfrom' => 'YouDaoCV',
            'key' => '659600698',
            'type' => 'data',
            'doctype' => 'json',
            'version' => '1.1',
            'q' => $argv[1],
        ],
    ],
);

if ($response->getStatusCode() !== 200) {
    fprintf(STDERR, "HTTP Status Code: %d" . PHP_EOL, $response->getStatusCode());
    fprintf(STDERR, "Headers:" . PHP_EOL);
    fwrite(STDERR, print_r($response->getHeaders(), return: true) . PHP_EOL);
    if ($response->getContent() !== '') {
        fprintf(STDERR, "Body:" . PHP_EOL);
        fwrite(STDERR, $response->getContent() . PHP_EOL);
    }
    exit(1);
}

$data = $response->toArray();

$colors = [
    'reset' => "\u{001b}[0m",
    'blue' => "\u{001b}[34m",
    'bold' => "\u{001b}[1m",
];

printf("%s [%s]" . PHP_EOL, $colors['bold'] . $data['query'] . $colors['reset'], $data['basic']['phonetic']);
echo PHP_EOL;

printf($colors['blue'] . $colors['bold'] . "* Basic Explains" . $colors['reset'] . PHP_EOL);
foreach ($data['basic']['explains'] as $explain) {
    printf('- %s' . PHP_EOL, $explain);
}
echo PHP_EOL;

printf($colors['blue'] . $colors['bold'] . "* Web References" . $colors['reset'] . PHP_EOL);
foreach ($data['web'] as $web) {
    printf("- %s %s::%s %s" . PHP_EOL, $colors['bold'], $web['key'], $colors['reset'], implode(';', $web['value']));
}
echo PHP_EOL;